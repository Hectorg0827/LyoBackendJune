steps:
  # Create Artifact Registry repository if it doesn't exist
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
    - -c
    - |
      # Enable required services
      gcloud services enable artifactregistry.googleapis.com --quiet
      gcloud services enable run.googleapis.com --quiet
      
      # Create repository (non-blocking if exists)
      gcloud artifacts repositories create lyo-backend-repo         --repository-format=docker         --location=${_REGION}         --description="Lyo Backend Docker images"         --quiet || echo "Repository may already exist"
      
      # Configure Docker authentication  
      gcloud auth configure-docker ${_REGION}-docker.pkg.dev --quiet

  # Build the container image using the production Dockerfile
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build', 
      '-f', 'Dockerfile.production',
      '-t', '${_IMAGE}:${BUILD_ID}',
      '-t', '${_IMAGE}:latest',
      '.'
    ]

  # Push the image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '--all-tags', '${_IMAGE}']

  # Deploy to Cloud Run (with all configuration)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
    - -c
    - |
      # Deploy with full configuration including Redis, secrets, and VPC connector
      gcloud run deploy ${_SERVICE}         --image ${_IMAGE}:${BUILD_ID}         --region ${_REGION}         --platform managed         --allow-unauthenticated         --port 8080         --memory 2Gi         --cpu 2         --min-instances 1         --max-instances 10         --vpc-connector=lyo-connector         --set-env-vars "ENVIRONMENT=production,DEBUG=false,GCP_PROJECT_ID=lyobackend,FIREBASE_PROJECT_ID=lyo-app,GCS_BUCKET_NAME=lyobackend-storage,REDIS_HOST=10.57.97.243,REDIS_PORT=6379,FIREBASE_CREDENTIALS_PATH=/secrets/firebase/credentials.json"         --set-secrets="SECRET_KEY=jwt-secret:latest,DATABASE_URL=database-url:latest,GEMINI_API_KEY=gemini-api-key:latest,GOOGLE_API_KEY=gemini-api-key:latest,OPENAI_API_KEY=openai-api-key:latest,STRIPE_SECRET_KEY=stripe-secret-key:latest,STRIPE_PUBLISHABLE_KEY=stripe-publishable-key:latest,STRIPE_WEBHOOK_SECRET=stripe-webhook-secret:latest,/secrets/firebase/credentials.json=firebase-credentials:latest"         --quiet
      
      echo "Deployment completed successfully!"

substitutions:
  _SERVICE: 'lyo-backend-production'
  _REGION: 'us-central1'  
  _IMAGE: 'us-central1-docker.pkg.dev/lyobackend/lyo-backend-repo/lyo-backend-production'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
